<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Dyslexic&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>Fitness Tracker - Register</title>
</head>
<body class="<%= theme %> <%= fontPref %>">

<!-- Flash Messages -->
<% if (messages.success) { %>
    <div class="flash success"><%= messages.success %></div>
<% } %>
<% if (messages.error) { %>
    <div class="flash error"><%= messages.error %></div>
<% } %>

<!-- Navbar -->
<nav>
    <div class="hamburger" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <ul>
        <li><a href="/" class="nav-link">Home</a></li>
        <li><a href="/dashboard" class="nav-link">Dashboard</a></li>

        <!-- Fitness Dropdown Button -->
        <li class="dropdown">
            <a href="javascript:void(0)" class="dropbtn" onclick="toggleDropdown()">Fitness</a>
            <div class="dropdown-content">
                <a href="/workout" class="dropdown-item">Generate Workout</a>
                <a href="/water" class="dropdown-item">Water Tracker</a>
                <a href="/sleep" class="dropdown-item">Sleep Tracker</a>
            </div>
        </li>

        <li><a href="/faq" class="nav-link">FAQ and Feedback</a></li>
        <li><a href="/settings" class="nav-link">Settings</a></li>

        <!-- User Icon -->
        <% if (user) { %>
            <li class="user-icon">
                <a href="/profile">
                    <span><%= user.username %></span>
                    <img src="/<%= user.profileIcon || 'avatarblack.png' %>" alt="User Icon" />
                </a>
            </li>
        <% } else { %>
            <li><a href="/users/login" class="nav-link">Login</a></li>
            <li><a href="/users/register" class="nav-link active">Sign Up</a></li>
        <% } %>
    </ul>
</nav>

<div class="register-container">
    <div class="register-card">
        <div class="card-header">
            <i class="fas fa-user-plus"></i>
            <h1>Create Account</h1>
            <p class="subtitle">Join us on your fitness journey</p>
        </div>

        <form id="registerForm" action="/users/register" method="POST" class="register-form">
            <div class="form-group">
                <label for="username">
                    <i class="fas fa-user"></i>
                    Username
                </label>
                <input 
                    type="text" 
                    id="username" 
                    name="username" 
                    required 
                    placeholder="Choose a username"
                    autocomplete="username"
                >
                <small class="error"></small>
                <small class="hint">Username must be between 3-20 characters</small>
            </div>

            <div class="form-group">
                <label for="email">
                    <i class="fas fa-envelope"></i>
                    Email Address
                </label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    required 
                    placeholder="Enter your email"
                    autocomplete="email"
                >
                <small class="error"></small>
            </div>

            <div class="form-group">
                <label for="password">
                    <i class="fas fa-lock"></i>
                    Password
                </label>
                <div class="password-input-group">
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required 
                        placeholder="Create a password"
                        autocomplete="new-password"
                    >
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <small class="error"></small>
                <small class="hint">Password must be at least 8 characters long</small>
                <div class="password-strength">
                    <div class="strength-bar">
                        <div class="strength-fill"></div>
                    </div>
                    <small class="strength-text">Password strength: <span>None</span></small>
                </div>
            </div>

            <div class="form-options">
                <label class="terms-checkbox">
                    <input type="checkbox" name="terms" id="terms" required>
                    <span>I agree to the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a></span>
                </label>
            </div>

            <button type="submit" class="register-button">
                <i class="fas fa-user-plus"></i>
                Create Account
            </button>

            <% if (message) { %>
                <div class="form-message error">
                    <i class="fas fa-exclamation-circle"></i>
                    <%= message %>
                </div>
            <% } %>
        </form>

        <div class="card-footer">
            <p>Already have an account? <a href="/users/login">Log in here</a></p>
        </div>
    </div>
</div>

<script>
    function toggleDropdown() {
        var dropdown = document.querySelector('.dropdown');
        dropdown.classList.toggle('active');
    }

    function toggleMenu() {
        const navList = document.querySelector('nav ul');
        navList.classList.toggle('active');
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const toggleButton = document.querySelector('.toggle-password i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleButton.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            toggleButton.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    function checkPasswordStrength(password) {
        let strength = 0;
        const strengthBar = document.querySelector('.strength-fill');
        const strengthText = document.querySelector('.strength-text span');

        // Length check
        if (password.length >= 8) strength += 25;
        
        // Contains number
        if (/\d/.test(password)) strength += 25;
        
        // Contains letter
        if (/[a-zA-Z]/.test(password)) strength += 25;
        
        // Contains special character
        if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 25;

        // Update UI
        strengthBar.style.width = strength + '%';
        
        // Update color and text based on strength
        if (strength <= 25) {
            strengthBar.style.backgroundColor = '#dc3545';
            strengthText.textContent = 'Weak';
        } else if (strength <= 50) {
            strengthBar.style.backgroundColor = '#ffc107';
            strengthText.textContent = 'Fair';
        } else if (strength <= 75) {
            strengthBar.style.backgroundColor = '#28a745';
            strengthText.textContent = 'Good';
        } else {
            strengthBar.style.backgroundColor = '#20c997';
            strengthText.textContent = 'Strong';
        }
    }

    document.getElementById('password').addEventListener('input', function(e) {
        checkPasswordStrength(e.target.value);
    });

    document.getElementById('registerForm').addEventListener('submit', function(e) {
        const username = document.getElementById('username');
        const email = document.getElementById('email');
        const password = document.getElementById('password');
        const terms = document.getElementById('terms');
        let isValid = true;

        // Clear previous errors
        document.querySelectorAll('.error').forEach(error => error.textContent = '');

        // Username validation
        if (!username.value.trim()) {
            username.nextElementSibling.textContent = 'Username is required';
            isValid = false;
        } else if (username.value.length < 3 || username.value.length > 20) {
            username.nextElementSibling.textContent = 'Username must be between 3 and 20 characters';
            isValid = false;
        }

        // Email validation
        if (!email.value.trim()) {
            email.nextElementSibling.textContent = 'Email is required';
            isValid = false;
        } else if (!isValidEmail(email.value.trim())) {
            email.nextElementSibling.textContent = 'Please enter a valid email address';
            isValid = false;
        }

        // Password validation
        if (!password.value.trim()) {
            password.parentElement.nextElementSibling.textContent = 'Password is required';
            isValid = false;
        } else if (password.value.length < 8) {
            password.parentElement.nextElementSibling.textContent = 'Password must be at least 8 characters long';
            isValid = false;
        }

        // Terms validation
        if (!terms.checked) {
            terms.parentElement.querySelector('.error') || 
            terms.parentElement.insertAdjacentHTML('beforeend', 
                '<small class="error">You must accept the Terms of Service and Privacy Policy</small>');
            isValid = false;
        }

        if (!isValid) e.preventDefault();
    });

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
</script>

</body>
</html>
